<!DOCTYPE html>
<html>
<head>
    <title>–≠–º–æ–¥–∑–∏-–±–∏—Ç–≤–∞: –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f0f0f0;
            overflow-x: hidden;
        }

        #game-container {
            display: flex;
            position: relative;
            min-height: calc(100vh - 40px);
            padding-left: 340px; /* –û—Ç—Å—Ç—É–ø –¥–ª—è –ø–∞–Ω–µ–ª–∏ */
            justify-content: center;
            align-items: center; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ */
            padding-top: 0; /* –£–±–∏—Ä–∞–µ–º –≤–µ—Ä—Ö–Ω–∏–π –æ—Ç—Å—Ç—É–ø –¥–ª—è –ª—É—á—à–µ–≥–æ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è */
        }

        #battlefield {
            border-collapse: collapse;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            table-layout: fixed;
            margin: 0 auto; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Ç–∞–±–ª–∏—Ü—É */
            transform: translateX(100px); /* –°–º–µ—â–∞–µ–º –ø–æ–ª–µ –≤–ø—Ä–∞–≤–æ */
        }
        
        .cell {
            width: 80px; /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä —è—á–µ–µ–∫ */
            height: 80px;
            border: 1px solid #ccc;
            text-align: center;
            font-size: 40px; /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä —ç–º–æ–¥–∑–∏ */
            cursor: pointer;
            position: relative;
            transition: background-color 0.3s;
            box-sizing: border-box;
        }
        
        .cell:hover {
            background-color: #f5f5f5;
        }
        
        .selected {
            background-color: #ffeb3b;
        }
        
        .info-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            width: 320px; /* –ù–µ–º–Ω–æ–≥–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É –ø–∞–Ω–µ–ª–∏ */
            position: fixed;
            left: 20px;
            top: 20px;
            bottom: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            z-index: 100; /* –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –ø–∞–Ω–µ–ª—å –≤—Å–µ–≥–¥–∞ –ø–æ–≤–µ—Ä—Ö */
        }
        
        .unit-info {
            background: white;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 20px;
            min-height: 300px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ */
        }

        .unit-info:empty {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
        }

        .unit-info:empty::after {
            content: "–í—ã–±–µ—Ä–∏—Ç–µ —é–Ω–∏—Ç–∞";
            font-style: italic;
        }

        #action-log {
            flex: 1;
            min-height: 200px;
            max-height: none;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: auto; /* –ü—Ä–∏–∂–∏–º–∞–µ–º –ª–æ–≥ –∫ –Ω–∏–∑—É */
            background: #f9f9f9;
        }

        .level-select {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(calc(-50% + 160px), -50%); /* –°–¥–≤–∏–≥–∞–µ–º –≤–ø—Ä–∞–≤–æ –Ω–∞ –ø–æ–ª–æ–≤–∏–Ω—É —à–∏—Ä–∏–Ω—ã –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ */
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            z-index: 1000;
            max-height: 90vh;
            overflow-y: auto;
            width: 60%; /* –£–º–µ–Ω—å—à–∞–µ–º —à–∏—Ä–∏–Ω—É */
            max-width: 800px;
            min-width: 400px;
        }

        .level-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .level-buttons button {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 6px;
            background: #4CAF50;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .level-buttons button:hover {
            background: #45a049;
        }

        .level-select h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }

        /* –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —Ñ–æ–Ω–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–≤–µ—Ä–ª–µ–π –∫–æ–≥–¥–∞ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ */
        .level-select:not([style*="display: none"]) ~ .modal-overlay {
            display: block;
        }

        .unit-selection {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 20px;
            padding: 10px;
            max-height: 70vh;
            overflow-y: auto;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ */
        .unit-selection::-webkit-scrollbar {
            width: 8px;
        }

        .unit-selection::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .unit-selection::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .unit-selection::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .unit-card {
            padding: 15px;
            border-radius: 8px;
            transition: all 0.3s;
            background: white;
            border: 1px solid #ddd;
            height: fit-content;
        }

        /* –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ù–∞—á–∞—Ç—å –±–∏—Ç–≤—É" */
        #unit-select button {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 1.1em;
            cursor: pointer;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            transition: all 0.3s;
        }

        #unit-select button:hover {
            background: #45a049;
        }

        /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ */
        .selection-header {
            position: sticky;
            top: 0;
            background: white;
            padding: 10px 0;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
            z-index: 1;
        }

        .unit-card:hover {
            background: #f5f5f5;
            transform: translateY(-2px);
        }

        .unit-card.selected {
            border-color: #4CAF50;
            background: #E8F5E9;
        }

        .level-info {
            background: #E3F2FD;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }

        @keyframes attack-animation {
            0% { transform: scale(1) translate(0, 0); }
            50% { transform: scale(1.2) translate(10px, -5px); }
            100% { transform: scale(1) translate(0, 0); }
        }

        .attack-effect {
            animation: attack-animation 0.3s ease-in-out;
        }

        .terrain {
            background-color: #90EE90;
        }

        .water {
            background-color: #4169E1;
            position: relative;
            overflow: hidden;
        }

        .water::after {
            content: 'üíß';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 40px;
            opacity: 0.8;
        }

        .mountain {
            background-color: #8B4513;
            position: relative;
            overflow: hidden;
        }

        .mountain::after {
            content: '‚õ∞Ô∏è';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 40px;
            opacity: 0.8;
        }

        .tree {
            background-color: #228B22;
            position: relative;
            overflow: hidden;
        }

        .tree::after {
            content: 'üå≥';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 40px;
            opacity: 0.8;
        }

        .available-move {
            position: relative;
        }

        .available-move::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(144, 238, 144, 0.3);
            pointer-events: none;
        }

        .available-attack {
            position: relative;
        }

        .available-attack::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 99, 71, 0.3);
            pointer-events: none;
        }

        .available-special {
            position: relative;
        }

        .available-special::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(147, 112, 219, 0.3);
            pointer-events: none;
        }

        .unit-card.unavailable {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .action-button {
            padding: 8px;
            cursor: pointer;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            transition: background-color 0.3s;
            text-align: center;
        }

        .action-button:hover {
            background: #f5f5f5;
        }

        .action-button.active {
            background-color: #4CAF50;
            color: white;
            border-color: #45a049;
        }

        .skip-turn-button {
            grid-column: 1 / -1;
            background: #666;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .skip-turn-button:hover {
            background: #555;
        }

        .ability-info {
            margin-top: 10px;
            padding: 5px;
            border-radius: 4px;
            background-color: rgba(0,0,0,0.05);
        }
        .ability-name {
            font-weight: bold;
            color: #4a4a4a;
        }
        .ability-description {
            font-size: 0.9em;
            color: #666;
        }
        .cooldown-info {
            font-size: 0.8em;
            color: #888;
        }
        .unit-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
            margin: 10px 0;
        }
        .unit-ability {
            margin-top: 8px;
            padding: 5px;
            background: rgba(0,0,0,0.03);
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div class="info-panel">
            <div class="level-info">
                <h2>–£—Ä–æ–≤–µ–Ω—å <span id="current-level">1</span></h2>
                <p>–û—Å—Ç–∞–ª–æ—Å—å –≤—Ä–∞–≥–æ–≤: <span id="enemies-left">0</span></p>
                <p>–¢–µ–∫—É—â–∏–π —Ö–æ–¥: <span id="current-turn">-</span></p>
            </div>
            <div class="unit-info" id="unit-info"></div>
            <div id="action-log"></div>
        </div>
        <table id="battlefield"></table>
    </div>

    <div id="level-select" class="level-select">
        <h2>–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å</h2>
        <div class="level-buttons">
            <button onclick="selectLevel(1)">–£—Ä–æ–≤–µ–Ω—å 1: –õ–µ—Å</button>
            <button onclick="selectLevel(2)">–£—Ä–æ–≤–µ–Ω—å 2: –ì–æ—Ä—ã</button>
            <button onclick="selectLevel(3)">–£—Ä–æ–≤–µ–Ω—å 3: –ó–∞–º–æ–∫</button>
        </div>
    </div>

    <div id="unit-select" class="level-select">
        <div class="selection-header">
            <h2>–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç—Ä—è–¥</h2>
            <p>–í—ã–±–µ—Ä–∏—Ç–µ 3 —é–Ω–∏—Ç–∞ –¥–ª—è –±–∏—Ç–≤—ã</p>
        </div>
        <div class="unit-selection" id="unit-selection"></div>
        <button onclick="startBattle()">–ù–∞—á–∞—Ç—å –±–∏—Ç–≤—É</button>
    </div>

    <div class="modal-overlay"></div>

    <script>
        const AVAILABLE_UNITS = {
            player: [
                {
                    type: 'ü¶Å', 
                    name: '–õ–µ–≤', 
                    hp: 120, 
                    attack: 18, 
                    initiative: 8,
                    range: 1,
                    activeAbility: {
                        name: '–†–µ–≤',
                        description: '–û–≥–ª—É—à–∞–µ—Ç –≤—Å–µ—Ö –≤—Ä–∞–≥–æ–≤ –≤ —Ä–∞–¥–∏—É—Å–µ 2 –∫–ª–µ—Ç–æ–∫, —Å–Ω–∏–∂–∞—è –∏—Ö –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É –Ω–∞ 2 —Ö–æ–¥–∞',
                        range: 2,
                        cooldown: 3
                    },
                    passiveAbility: {
                        name: '–ö–æ—Ä–æ–ª—å –∑–≤–µ—Ä–µ–π',
                        description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∞—Ç–∞–∫—É –Ω–∞ 5 –∑–∞ –∫–∞–∂–¥–æ–≥–æ —Å–æ—é–∑–Ω–∏–∫–∞ —Ä—è–¥–æ–º'
                    }
                },
                {
                    type: 'üõ°Ô∏è', 
                    name: '–†—ã—Ü–∞—Ä—å', 
                    hp: 150, 
                    attack: 15, 
                    initiative: 5,
                    range: 1,
                    activeAbility: {
                        name: '–©–∏—Ç–æ–≤–∞—è —Å—Ç–µ–Ω–∞',
                        description: '–ó–∞—â–∏—â–∞–µ—Ç —Å–æ—é–∑–Ω–∏–∫–∞, –ø—Ä–∏–Ω–∏–º–∞—è –≤–µ—Å—å —É—Ä–æ–Ω –Ω–∞ —Å–µ–±—è –≤ —Ç–µ—á–µ–Ω–∏–µ 2 —Ö–æ–¥–æ–≤',
                        range: 2,
                        cooldown: 4
                    },
                    passiveAbility: {
                        name: '–°—Ç–∞–ª—å–Ω–∞—è –≤–æ–ª—è',
                        description: '–ü–æ–ª—É—á–∞–µ—Ç +5 –∫ –∑–∞—â–∏—Ç–µ –∑–∞ –∫–∞–∂–¥—ã–µ –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã–µ 20% HP'
                    }
                },
                {
                    type: 'üßô', 
                    name: '–ú–∞–≥', 
                    hp: 80, 
                    attack: 25, 
                    initiative: 7,
                    range: 1,
                    activeAbility: {
                        name: '–û–≥–Ω–µ–Ω–Ω—ã–π —à–∞—Ä',
                        description: '–ù–∞–Ω–æ—Å–∏—Ç 150% —É—Ä–æ–Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–µ–ª–∏ –∏ 50% —É—Ä–æ–Ω–∞ –≤—Å–µ–º –≤ —Ä–∞–¥–∏—É—Å–µ 1 –∫–ª–µ—Ç–∫–∏',
                        range: 3,
                        cooldown: 2
                    },
                    passiveAbility: {
                        name: '–ú—É–¥—Ä–æ—Å—Ç—å –≤–µ–∫–æ–≤',
                        description: '–ö–∞–∂–¥—ã–π —Ö–æ–¥ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç 5 HP –∏ —É–º–µ–Ω—å—à–∞–µ—Ç –ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫—É —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π —Å–æ—é–∑–Ω–∏–∫–æ–≤ –Ω–∞ 1'
                    }
                },
                {
                    type: 'üèπ', 
                    name: '–õ—É—á–Ω–∏–∫', 
                    hp: 90, 
                    attack: 20, 
                    initiative: 9,
                    range: 2,
                    activeAbility: {
                        name: '–ó–∞–ª–ø',
                        description: '–í—ã–ø—É—Å–∫–∞–µ—Ç —Å—Ç—Ä–µ–ª—ã –ø–æ —Ç—Ä–µ–º —Ü–µ–ª—è–º –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –¥–∞–ª—å–Ω–æ—Å—Ç–∏',
                        range: 2,
                        cooldown: 3
                    },
                    passiveAbility: {
                        name: '–ú–µ—Ç–∫–∏–π –≥–ª–∞–∑',
                        description: '–ú–æ–∂–µ—Ç –∞—Ç–∞–∫–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è –∏ —Å–æ—é–∑–Ω–∏–∫–æ–≤, –≤–∫–ª—é—á–∞—è –¥–∏–∞–≥–æ–Ω–∞–ª—å–Ω—ã–µ –∞—Ç–∞–∫–∏'
                    }
                },
                {
                    type: '‚öîÔ∏è', 
                    name: '–ë–µ—Ä—Å–µ—Ä–∫', 
                    hp: 100, 
                    attack: 30, 
                    initiative: 6,
                    range: 1,
                    activeAbility: {
                        name: '–Ø—Ä–æ—Å—Ç—å',
                        description: '–£–¥–≤–∞–∏–≤–∞–µ—Ç –∞—Ç–∞–∫—É –Ω–∞ 2 —Ö–æ–¥–∞, –Ω–æ –ø–æ–ª—É—á–∞–µ—Ç –Ω–∞ 50% –±–æ–ª—å—à–µ —É—Ä–æ–Ω–∞',
                        range: 0,
                        cooldown: 4
                    },
                    passiveAbility: {
                        name: '–ñ–∞–∂–¥–∞ –∫—Ä–æ–≤–∏',
                        description: '–ü–æ–ª—É—á–∞–µ—Ç +5 –∫ –∞—Ç–∞–∫–µ –∑–∞ –∫–∞–∂–¥—ã–µ –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã–µ 10% HP'
                    }
                },
                {
                    type: 'üíâ', 
                    name: '–õ–µ–∫–∞—Ä—å', 
                    hp: 70, 
                    attack: 10, 
                    initiative: 4,
                    range: 1,
                    activeAbility: {
                        name: '–ò—Å—Ü–µ–ª–µ–Ω–∏–µ',
                        description: '–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç 30 HP —Ü–µ–ª–∏ –∏ —Å–Ω–∏–º–∞–µ—Ç –≤—Å–µ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã',
                        range: 2,
                        cooldown: 2
                    },
                    passiveAbility: {
                        name: '–ê—É—Ä–∞ –∂–∏–∑–Ω–∏',
                        description: '–í—Å–µ —Å–æ—é–∑–Ω–∏–∫–∏ –≤ —Ä–∞–¥–∏—É—Å–µ 2 –∫–ª–µ—Ç–æ–∫ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç 5 HP –≤ –Ω–∞—á–∞–ª–µ —Ö–æ–¥–∞'
                    }
                },
                {
                    type: 'ü¶Ö', 
                    name: '–ì—Ä–∏—Ñ–æ–Ω', 
                    hp: 110, 
                    attack: 22, 
                    initiative: 10,
                    range: 1,
                    activeAbility: {
                        name: '–í–æ–∑–¥—É—à–Ω—ã–π —É–¥–∞—Ä',
                        description: '–ü–µ—Ä–µ–ª–µ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ –≤—Ä–∞–≥–∞, –æ–≥–ª—É—à–∞—è –µ–≥–æ, –∏ –∞—Ç–∞–∫—É–µ—Ç —Å —É–¥–≤–æ–µ–Ω–Ω–æ–π —Å–∏–ª–æ–π',
                        range: 3,
                        cooldown: 3
                    },
                    passiveAbility: {
                        name: '–ü–æ–ª—ë—Ç',
                        description: '–ú–æ–∂–µ—Ç –ø–µ—Ä–µ–º–µ—â–∞—Ç—å—Å—è –Ω–∞ 2 –∫–ª–µ—Ç–∫–∏, –≤–∫–ª—é—á–∞—è –¥–∏–∞–≥–æ–Ω–∞–ª—å–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ'
                    }
                },
                {
                    type: 'üêâ', 
                    name: '–î—Ä–∞–∫–æ–Ω—á–∏–∫', 
                    hp: 130, 
                    attack: 28, 
                    initiative: 7,
                    range: 1,
                    activeAbility: {
                        name: '–û–≥–Ω–µ–Ω–Ω–æ–µ –¥—ã—Ö–∞–Ω–∏–µ',
                        description: '–ù–∞–Ω–æ—Å–∏—Ç —É—Ä–æ–Ω –≤—Å–µ–º –≤—Ä–∞–≥–∞–º –≤ –ª–∏–Ω–∏–∏ –¥–ª–∏–Ω–æ–π 3 –∫–ª–µ—Ç–∫–∏',
                        range: 3,
                        cooldown: 3
                    },
                    passiveAbility: {
                        name: '–î—Ä–∞–∫–æ–Ω—å—è —á–µ—à—É—è',
                        description: '–ü–æ–ª—É—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ 75% —É—Ä–æ–Ω–∞ –æ—Ç —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö –∞—Ç–∞–∫'
                    }
                },
                {
                    type: 'üßù', 
                    name: '–°–ª–µ–¥–æ–ø—ã—Ç', 
                    hp: 95, 
                    attack: 23, 
                    initiative: 8,
                    range: 2,
                    activeAbility: {
                        name: '–õ–æ–≤—É—à–∫–∞',
                        description: '–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ª–æ–≤—É—à–∫—É, –∫–æ—Ç–æ—Ä–∞—è –æ–±–µ–∑–¥–≤–∏–∂–∏–≤–∞–µ—Ç –≤—Ä–∞–≥–∞ –Ω–∞ 2 —Ö–æ–¥–∞',
                        range: 3,
                        cooldown: 4
                    },
                    passiveAbility: {
                        name: '–ó–Ω–∞–Ω–∏–µ –º–µ—Å—Ç–Ω–æ—Å—Ç–∏',
                        description: '–ò–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç —à—Ç—Ä–∞—Ñ—ã –æ—Ç –º–µ—Å—Ç–Ω–æ—Å—Ç–∏ –∏ –ø–æ–ª—É—á–∞–µ—Ç +2 –∫ –∞—Ç–∞–∫–µ –≤ –ª–µ—Å—É'
                    }
                },
                {
                    type: '‚ö°', 
                    name: '–®–∞–º–∞–Ω', 
                    hp: 85, 
                    attack: 20, 
                    initiative: 6,
                    range: 1,
                    activeAbility: {
                        name: '–¶–µ–ø–Ω–∞—è –º–æ–ª–Ω–∏—è',
                        description: '–ù–∞–Ω–æ—Å–∏—Ç —É—Ä–æ–Ω —Ü–µ–ª–∏ –∏ –ø–µ—Ä–µ—Å–∫–∞–∫–∏–≤–∞–µ—Ç –Ω–∞ 2 –±–ª–∏–∂–∞–π—à–∏—Ö –≤—Ä–∞–≥–æ–≤',
                        range: 2,
                        cooldown: 3
                    },
                    passiveAbility: {
                        name: '–î—É—Ö–æ–≤–Ω–∞—è —Å–≤—è–∑—å',
                        description: '–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —É—Ä–æ–Ω–∞ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç HP —Å–ª—É—á–∞–π–Ω–æ–º—É —Å–æ—é–∑–Ω–∏–∫—É'
                    }
                },
                {
                    type: 'üó°Ô∏è', 
                    name: '–ê—Å—Å–∞—Å–∏–Ω', 
                    hp: 75, 
                    attack: 35, 
                    initiative: 9,
                    range: 1,
                    activeAbility: {
                        name: '–¢–µ–Ω–µ–≤–æ–π –ø—Ä—ã–∂–æ–∫',
                        description: '–¢–µ–ª–µ–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –∑–∞ —Å–ø–∏–Ω—É –≤—Ä–∞–≥–∞ –∏ –Ω–∞–Ω–æ—Å–∏—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É–¥–∞—Ä',
                        range: 3,
                        cooldown: 4
                    },
                    passiveAbility: {
                        name: '–°–∫—Ä—ã—Ç–Ω–æ—Å—Ç—å',
                        description: '–ü–æ—Å–ª–µ —É–±–∏–π—Å—Ç–≤–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –Ω–µ–≤–∏–¥–∏–º—ã–º –Ω–∞ 1 —Ö–æ–¥'
                    }
                },
                {
                    type: 'üé≠', 
                    name: '–ú–µ–Ω–µ—Å—Ç—Ä–µ–ª—å', 
                    hp: 70, 
                    attack: 15, 
                    initiative: 5,
                    range: 2,
                    activeAbility: {
                        name: '–í–æ–æ–¥—É—à–µ–≤–ª—è—é—â–∞—è –ø–µ—Å–Ω—è',
                        description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∞—Ç–∞–∫—É –∏ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É –≤—Å–µ—Ö —Å–æ—é–∑–Ω–∏–∫–æ–≤ –≤ —Ä–∞–¥–∏—É—Å–µ 2 –∫–ª–µ—Ç–æ–∫',
                        range: 2,
                        cooldown: 3
                    },
                    passiveAbility: {
                        name: '–í–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ',
                        description: '–°–æ—é–∑–Ω–∏–∫–∏ —Ä—è–¥–æ–º –ø–æ–ª—É—á–∞—é—Ç +2 –∫ –∞—Ç–∞–∫–µ –∏ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–µ'
                    }
                }
            ]
        };

        const LEVELS = {
            1: {
                name: '–õ–µ—Å',
                size: 8,
                enemies: [
                    {type: 'üê∫', name: '–í–æ–ª–∫', hp: 80, attack: 15, initiative: 7},
                    {type: 'üêó', name: '–ö–∞–±–∞–Ω', hp: 100, attack: 12, initiative: 5},
                    {type: 'ü¶ä', name: '–õ–∏—Å–∞', hp: 60, attack: 18, initiative: 9}
                ],
                terrain: [
                    {type: 'tree', x: 3, y: 3},
                    {type: 'tree', x: 4, y: 4},
                    {type: 'tree', x: 2, y: 5}
                ]
            },
            2: {
                name: '–ì–æ—Ä—ã',
                size: 10,
                enemies: [
                    {type: 'üßü', name: '–ó–æ–º–±–∏', hp: 120, attack: 15, initiative: 4},
                    {type: 'üëª', name: '–ü—Ä–∏–∑—Ä–∞–∫', hp: 90, attack: 20, initiative: 8},
                    {type: 'üíÄ', name: '–°–∫–µ–ª–µ—Ç', hp: 100, attack: 18, initiative: 6}
                ],
                terrain: [
                    {type: 'mountain', x: 4, y: 4},
                    {type: 'mountain', x: 5, y: 5},
                    {type: 'mountain', x: 3, y: 6},
                    {type: 'tree', x: 1, y: 3},
                    {type: 'tree', x: 6, y: 2},
                    {type: 'tree', x: 8, y: 4}
                ]
            },
            3: {
                name: '–ó–∞–º–æ–∫',
                size: 12,
                enemies: [
                    {type: 'üëπ', name: '–î–µ–º–æ–Ω', hp: 150, attack: 25, initiative: 7},
                    {type: 'üßõ', name: '–í–∞–º–ø–∏—Ä', hp: 130, attack: 22, initiative: 9},
                    {type: 'üëø', name: '–¢—ë–º–Ω—ã–π –º–∞–≥', hp: 140, attack: 28, initiative: 8}
                ],
                terrain: [
                    {type: 'water', x: 5, y: 5},
                    {type: 'water', x: 6, y: 6},
                    {type: 'mountain', x: 4, y: 7}
                ]
            }
        };

        let currentLevel = 1;
        let selectedUnits = [];
        let units = {
            player: [],
            enemy: []
        };
        let selectedUnit = null;
        let turnQueue = [];
        let currentUnitIndex = 0;
        let currentAction = 'move'; // 'move', 'attack', 'special'
        let usedUnits = new Set(); // –•—Ä–∞–Ω–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö —é–Ω–∏—Ç–æ–≤

        function initGame() {
            document.getElementById('level-select').style.display = 'block';
        }

        function selectLevel(level) {
            currentLevel = level;
            usedUnits.clear(); // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö —é–Ω–∏—Ç–æ–≤
            document.getElementById('level-select').style.display = 'none';
            showUnitSelection();
        }

        function showUnitSelection() {
            const container = document.getElementById('unit-selection');
            const unitSelect = document.getElementById('unit-select');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É HTML –¥–ª—è –æ–∫–Ω–∞ –≤—ã–±–æ—Ä–∞
            unitSelect.innerHTML = `
                <div class="selection-header">
                    <h2>–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç—Ä—è–¥</h2>
                    <p>–í—ã–±–µ—Ä–∏—Ç–µ 3 —é–Ω–∏—Ç–∞ –¥–ª—è –±–∏—Ç–≤—ã</p>
                </div>
                <div class="unit-selection" id="unit-selection"></div>
                <button onclick="startBattle()">–ù–∞—á–∞—Ç—å –±–∏—Ç–≤—É</button>
            `;

            const selectionContainer = document.getElementById('unit-selection');
            selectionContainer.innerHTML = '';
            
            AVAILABLE_UNITS.player.forEach((unit, index) => {
                const card = document.createElement('div');
                card.className = 'unit-card';
                if (usedUnits.has(unit.type)) {
                    card.classList.add('unavailable');
                }
                card.innerHTML = `
                    <div style="font-size: 2em">${unit.type}</div>
                    <div style="font-weight: bold">${unit.name}</div>
                    <div class="unit-stats">
                        <div>‚ù§Ô∏è HP: ${unit.hp}</div>
                        <div>‚öîÔ∏è –ê—Ç–∞–∫–∞: ${unit.attack}</div>
                        <div>üèÉ –ò–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞: ${unit.initiative}</div>
                        <div>üìè –î–∞–ª—å–Ω–æ—Å—Ç—å: ${unit.range}</div>
                    </div>
                    <div class="unit-ability">
                        <div class="ability-name">‚ú® ${unit.activeAbility.name}</div>
                        <div class="ability-description">${unit.activeAbility.description}</div>
                        <div class="cooldown-info">‚è±Ô∏è –ü–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞: ${unit.activeAbility.cooldown} —Ö–æ–¥–∞</div>
                    </div>
                    <div class="unit-ability">
                        <div class="ability-name">üîÆ ${unit.passiveAbility.name}</div>
                        <div class="ability-description">${unit.passiveAbility.description}</div>
                    </div>
                `;
                if (!usedUnits.has(unit.type)) {
                    card.onclick = () => toggleUnitSelection(index);
                }
                selectionContainer.appendChild(card);
            });
            
            unitSelect.style.display = 'block';
        }

        function toggleUnitSelection(index) {
            const unit = AVAILABLE_UNITS.player[index];
            const card = document.querySelectorAll('.unit-card')[index];
            
            if (selectedUnits.includes(unit)) {
                selectedUnits = selectedUnits.filter(u => u !== unit);
                card.classList.remove('selected');
                usedUnits.delete(unit.type);
            } else if (selectedUnits.length < 3) {
                selectedUnits.push(unit);
                card.classList.add('selected');
                usedUnits.add(unit.type);
            }
        }

        function startBattle() {
            if (selectedUnits.length !== 3) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–≤–Ω–æ 3 —é–Ω–∏—Ç–∞!');
                return;
            }

            document.getElementById('unit-select').style.display = 'none';
            
            // –†–∞–∑–º–µ—â–∞–µ–º —é–Ω–∏—Ç–æ–≤ –∏–≥—Ä–æ–∫–∞ –≤ –Ω–∞—á–∞–ª—å–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏
            units.player = selectedUnits.map((unit, index) => ({
                ...unit,
                x: 0,  // –ù–∞—á–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –ø–æ X
                y: index + 1,  // –ù–∞—á–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –ø–æ Y
                cooldowns: {
                    special: 0
                }
            }));

            const level = LEVELS[currentLevel];
            // –†–∞–∑–º–µ—â–∞–µ–º –≤—Ä–∞–≥–æ–≤ –≤ –∫–æ–Ω—Ü–µ –ø–æ–ª—è
            units.enemy = level.enemies.map((enemy, index) => ({
                ...enemy,
                x: level.size - 1,  // –ü—Ä–∞–≤—ã–π –∫—Ä–∞–π –ø–æ–ª—è
                y: index + 1,  // –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ Y
                range: enemy.range || 1  // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–ª—å–Ω–æ—Å—Ç—å –∞—Ç–∞–∫–∏, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–∞
            }));

            createBattlefield(level.size);
            document.getElementById('current-level').textContent = currentLevel;
            document.getElementById('enemies-left').textContent = units.enemy.length;
            
            // –ù–∞—á–∏–Ω–∞–µ–º –ø–µ—Ä–≤—ã–π —Ä–∞—É–Ω–¥
            startNewRound();
        }

        function createBattlefield(size) {
            const table = document.getElementById('battlefield');
            table.innerHTML = '';
            
            for(let y = 0; y < size; y++) {
                const row = table.insertRow();
                for(let x = 0; x < size; x++) {
                    const cell = row.insertCell();
                    cell.className = 'cell';
                    cell.dataset.x = x;
                    cell.dataset.y = y;
                    cell.addEventListener('click', handleCellClick);
                }
            }

            // –î–æ–±–∞–≤–ª—è–µ–º terrain
            LEVELS[currentLevel].terrain.forEach(t => {
                const cell = document.querySelector(`[data-x="${t.x}"][data-y="${t.y}"]`);
                if (cell) {
                    cell.classList.add(t.type);
                }
            });

            updateBattlefield();
        }

        function startNewRound() {
            // –°–æ–∑–¥–∞–µ–º –æ—á–µ—Ä–µ–¥—å —Ö–æ–¥–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã
            turnQueue = [...units.player, ...units.enemy]
                .sort((a, b) => b.initiative - a.initiative);
            
            currentUnitIndex = 0;
            selectedUnit = null;
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–≤—ã–π —Ö–æ–¥
            processNextTurn();
        }

        function processNextTurn() {
            if(currentUnitIndex >= turnQueue.length) {
                startNewRound();
                return;
            }

            const currentUnit = turnQueue[currentUnitIndex];
            const isPlayerUnit = units.player.includes(currentUnit);
            
            document.getElementById('current-turn').textContent = 
                `${currentUnit.type} ${currentUnit.name} (${isPlayerUnit ? '–ò–≥—Ä–æ–∫' : '–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫'})`;

            if(!isPlayerUnit) {
                setTimeout(() => enemyTurn(currentUnit), 500);
            } else {
                // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ö–æ–¥—ã –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —é–Ω–∏—Ç–∞
                highlightAvailableCells(currentUnit);
            }
        }

        function highlightAvailableCells(unit) {
            const cells = document.getElementsByClassName('cell');
            for(let cell of cells) {
                cell.classList.remove('available-move', 'available-attack', 'available-special');
            }

            const level = LEVELS[currentLevel];
            for(let y = 0; y < level.size; y++) {
                for(let x = 0; x < level.size; x++) {
                    const distance = Math.abs(unit.x - x) + Math.abs(unit.y - y);
                    const diagonalDistance = Math.max(Math.abs(unit.x - x), Math.abs(unit.y - y));
                    const cell = document.querySelector(`[data-x="${x}"][data-y="${y}"]`);
                    
                    if (!cell) continue;

                    // –î–≤–∏–∂–µ–Ω–∏–µ (–≤–∫–ª—é—á–∞—è –¥–∏–∞–≥–æ–Ω–∞–ª—å–Ω–æ–µ)
                    if (currentAction === 'move') {
                        if (diagonalDistance <= 1 && isValidCell({x, y})) {
                            cell.classList.add('available-move');
                        }
                    }
                    // –ê—Ç–∞–∫–∞
                    else if (currentAction === 'attack') {
                        if (unit.type === 'üèπ') { // –õ—É—á–Ω–∏–∫ –º–æ–∂–µ—Ç —Å—Ç—Ä–µ–ª—è—Ç—å –ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏ –∏ —á–µ—Ä–µ–∑ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
                            if (diagonalDistance <= unit.range) {
                                const targetEnemy = units.enemy.find(e => e.x === x && e.y === y);
                                if (targetEnemy) {
                                    cell.classList.add('available-attack');
                                }
                            }
                        } else if (distance <= unit.range) {
                            const targetEnemy = units.enemy.find(e => e.x === x && e.y === y);
                            if (targetEnemy) {
                                cell.classList.add('available-attack');
                            }
                        }
                    }
                    // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
                    else if (currentAction === 'special') {
                        const ability = unit.activeAbility;
                        if (distance <= ability.range) {
                            switch(unit.type) {
                                case 'üßô': // –ú–∞–≥ - –û–≥–Ω–µ–Ω–Ω—ã–π —à–∞—Ä
                                case 'üêâ': // –î—Ä–∞–∫–æ–Ω—á–∏–∫ - –û–≥–Ω–µ–Ω–Ω–æ–µ –¥—ã—Ö–∞–Ω–∏–µ
                                case '‚ö°': // –®–∞–º–∞–Ω - –¶–µ–ø–Ω–∞—è –º–æ–ª–Ω–∏—è
                                    const targetEnemy = units.enemy.find(e => e.x === x && e.y === y);
                                    if (targetEnemy) {
                                        cell.classList.add('available-special');
                                    }
                                    break;
                                case 'üíâ': // –õ–µ–∫–∞—Ä—å - –ò—Å—Ü–µ–ª–µ–Ω–∏–µ
                                    const targetAlly = units.player.find(p => p.x === x && p.y === y && p !== unit);
                                    if (targetAlly) {
                                        cell.classList.add('available-special');
                                    }
                                    break;
                                case 'ü¶Å': // –õ–µ–≤ - –†–µ–≤
                                    if (distance <= ability.range) {
                                        cell.classList.add('available-special');
                                    }
                                    break;
                                // –î–æ–±–∞–≤—å—Ç–µ –¥—Ä—É–≥–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–ª—É—á–∞–∏ –∑–¥–µ—Å—å
                            }
                        }
                    }
                }
            }
        }

        function handleCellClick(e) {
            const x = parseInt(e.target.dataset.x);
            const y = parseInt(e.target.dataset.y);
            
            const currentUnit = turnQueue[currentUnitIndex];
            if(!units.player.includes(currentUnit)) return;

            // –ï—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –ø–æ —Ç–µ–∫—É—â–µ–º—É —é–Ω–∏—Ç—É
            const unit = units.player.find(u => u.x === x && u.y === y);
            if(unit && unit === currentUnit) {
                selectedUnit = unit;
                updateBattlefield();
                showUnitInfo(unit);
                return;
            }

            // –ï—Å–ª–∏ —é–Ω–∏—Ç —É–∂–µ –≤—ã–±—Ä–∞–Ω
            if(selectedUnit === currentUnit) {
                if (currentAction === 'move' && e.target.classList.contains('available-move')) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–Ω—è—Ç–∞ –ª–∏ –∫–ª–µ—Ç–∫–∞ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ–º
                    const terrain = LEVELS[currentLevel].terrain.find(t => t.x === x && t.y === y);
                    if (!terrain) {
                        moveUnit(selectedUnit, x, y);
                        selectedUnit = null;
                        endTurn();
                    }
                }
                else if (currentAction === 'attack' && e.target.classList.contains('available-attack')) {
                    const enemy = units.enemy.find(u => u.x === x && u.y === y);
                    if (enemy) {
                        attack(selectedUnit, enemy);
                        selectedUnit = null;
                        endTurn();
                    }
                }
                else if (currentAction === 'special' && e.target.classList.contains('available-special')) {
                    useSpecialAbility(selectedUnit, x, y);
                    selectedUnit = null;
                    endTurn();
                }
            } else {
                // –ï—Å–ª–∏ –Ω–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —é–Ω–∏—Ç–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—Ä–∞–∂–µ—Å–∫–æ–º —é–Ω–∏—Ç–µ
                const enemyUnit = units.enemy.find(u => u.x === x && u.y === y);
                if (enemyUnit) {
                    showUnitInfo(enemyUnit, true);
                }
            }
        }

        function endTurn() {
            // –£–º–µ–Ω—å—à–∞–µ–º –ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫—É —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π
            turnQueue.forEach(unit => {
                if (unit.cooldowns && unit.cooldowns.special > 0) {
                    unit.cooldowns.special--;
                }
            });

            currentUnitIndex++;
            selectedUnit = null;
            document.getElementById('unit-info').innerHTML = '';
            processNextTurn();
        }

        function isEmptyCell(x, y) {
            return ![...units.player, ...units.enemy].some(u => u.x === x && u.y === y);
        }

        function isAdjacent(a, b) {
            return Math.abs(a.x - b.x) <= 1 && Math.abs(a.y - b.y) <= 1;
        }

        function moveUnit(unit, newX, newY) {
            // –°–æ–∑–¥–∞–µ–º –∫–æ–ø–∏—é –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
            const cell = document.querySelector(`[data-x="${unit.x}"][data-y="${unit.y}"]`);
            const targetCell = document.querySelector(`[data-x="${newX}"][data-y="${newY}"]`);
            
            if(cell && targetCell) {
                const unitElement = document.createElement('div');
                unitElement.textContent = unit.type;
                unitElement.style.position = 'fixed';
                unitElement.style.fontSize = '35px';
                unitElement.style.pointerEvents = 'none';
                unitElement.style.zIndex = '1000';
                
                const startRect = cell.getBoundingClientRect();
                const endRect = targetCell.getBoundingClientRect();
                
                unitElement.style.left = startRect.left + 'px';
                unitElement.style.top = startRect.top + 'px';
                
                document.body.appendChild(unitElement);
                
                // –ê–Ω–∏–º–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
                unitElement.style.transition = 'all 0.3s ease-in-out';
                requestAnimationFrame(() => {
                    unitElement.style.left = endRect.left + 'px';
                    unitElement.style.top = endRect.top + 'px';
                });
                
                // –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏
                setTimeout(() => {
                    unit.x = newX;
                    unit.y = newY;
                    document.body.removeChild(unitElement);
                    logAction(`üèÉ ${unit.type} ${unit.name} –ø–µ—Ä–µ–º–µ—â–∞–µ—Ç—Å—è –Ω–∞ (${newX}, ${newY})`);
                    updateBattlefield();
                }, 300);
            } else {
                // –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–º–µ—â–∞–µ–º –±–µ–∑ –∞–Ω–∏–º–∞—Ü–∏–∏
                unit.x = newX;
                unit.y = newY;
                logAction(`üèÉ ${unit.type} ${unit.name} –ø–µ—Ä–µ–º–µ—â–∞–µ—Ç—Å—è –Ω–∞ (${newX}, ${newY})`);
                updateBattlefield();
            }
        }

        function attack(attacker, defender, damage = attacker.attack) {
            const attackerCell = document.querySelector(`[data-x="${attacker.x}"][data-y="${attacker.y}"]`);
            const defenderCell = document.querySelector(`[data-x="${defender.x}"][data-y="${defender.y}"]`);
            
            if(attackerCell && defenderCell) {
                // –ê–Ω–∏–º–∞—Ü–∏—è –∞—Ç–∞–∫–∏
                attackerCell.classList.add('attack-effect');
                
                // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∞—Ç–∞–∫–∏
                const attackEffect = document.createElement('div');
                attackEffect.style.position = 'fixed';
                attackEffect.style.width = '2px';
                attackEffect.style.background = 'red';
                attackEffect.style.transformOrigin = 'top';
                attackEffect.style.zIndex = '999';
                
                const startRect = attackerCell.getBoundingClientRect();
                const endRect = defenderCell.getBoundingClientRect();
                
                const angle = Math.atan2(endRect.top - startRect.top, endRect.left - startRect.left);
                const distance = Math.sqrt(
                    Math.pow(endRect.left - startRect.left, 2) + 
                    Math.pow(endRect.top - startRect.top, 2)
                );
                
                attackEffect.style.left = startRect.left + startRect.width/2 + 'px';
                attackEffect.style.top = startRect.top + startRect.height/2 + 'px';
                attackEffect.style.height = distance + 'px';
                attackEffect.style.transform = `rotate(${angle}rad)`;
                
                document.body.appendChild(attackEffect);
                
                // –ê–Ω–∏–º–∞—Ü–∏—è –∞—Ç–∞–∫–∏
                attackEffect.style.transition = 'opacity 0.3s';
                requestAnimationFrame(() => {
                    attackEffect.style.opacity = '0';
                });
                
                setTimeout(() => {
                    document.body.removeChild(attackEffect);
                    attackerCell.classList.remove('attack-effect');
                    
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º —É—Ä–æ–Ω
                    defender.hp -= damage;
                    logAction(`‚öîÔ∏è ${attacker.type} ${attacker.name} –∞—Ç–∞–∫—É–µ—Ç ${defender.type} ${defender.name} (${Math.round(defender.hp + damage)} ‚Üí ${Math.round(defender.hp)})`);
                    
                    if(defender.hp <= 0) {
                        const faction = units.player.includes(defender) ? 'player' : 'enemy';
                        units[faction] = units[faction].filter(u => u !== defender);
                        logAction(`üíÄ ${defender.type} ${defender.name} —É–Ω–∏—á—Ç–æ–∂–µ–Ω!`);
                        checkVictory();
                    }
                    updateBattlefield();
                }, 300);
            }
        }

        function enemyTurn(currentUnit) {
            const targets = [...units.player];
            if(targets.length === 0) return;

            let nearestTarget = targets.reduce((prev, curr) => 
                distance(currentUnit, curr) < distance(currentUnit, prev) ? curr : prev
            , targets[0]);

            if(isAdjacent(currentUnit, nearestTarget)) {
                attack(currentUnit, nearestTarget);
                endTurn();
                return;
            }

            const dx = nearestTarget.x - currentUnit.x;
            const dy = nearestTarget.y - currentUnit.y;
            
            let moveX = currentUnit.x;
            let moveY = currentUnit.y;
            
            if(isValidCell({x: currentUnit.x + Math.sign(dx), y: currentUnit.y + Math.sign(dy)})) {
                moveX += Math.sign(dx);
                moveY += Math.sign(dy);
            } 
            else if(Math.abs(dx) > Math.abs(dy)) {
                moveX += Math.sign(dx);
            } else {
                moveY += Math.sign(dy);
            }

            if(!isValidCell({x: moveX, y: moveY})) {
                const possibleMoves = [
                    {x: currentUnit.x + 1, y: currentUnit.y},
                    {x: currentUnit.x - 1, y: currentUnit.y},
                    {x: currentUnit.x, y: currentUnit.y + 1},
                    {x: currentUnit.x, y: currentUnit.y - 1}
                ];
                
                for(let move of possibleMoves) {
                    if(isValidCell(move)) {
                        moveX = move.x;
                        moveY = move.y;
                        break;
                    }
                }
            }
            
            if(moveX !== currentUnit.x || moveY !== currentUnit.y) {
                moveUnit(currentUnit, moveX, moveY);
            }
            
            endTurn();
        }

        function distance(unit1, unit2) {
            return Math.abs(unit1.x - unit2.x) + Math.abs(unit1.y - unit2.y);
        }

        function isValidCell(pos) {
            const level = LEVELS[currentLevel];
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –ø–æ–ª—è
            if (pos.x < 0 || pos.x >= level.size || pos.y < 0 || pos.y >= level.size) {
                return false;
            }
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–Ω—è—Ç–∞ –ª–∏ –∫–ª–µ—Ç–∫–∞ –¥—Ä—É–≥–∏–º —é–Ω–∏—Ç–æ–º
            if (!isEmptyCell(pos.x, pos.y)) {
                return false;
            }
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ –≤ –∫–ª–µ—Ç–∫–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
            const terrain = level.terrain.find(t => t.x === pos.x && t.y === pos.y);
            if (terrain && terrain.type !== 'water') { // –≤–æ–¥–∞ –Ω–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ–º
                return false;
            }
            return true;
        }

        function showUnitInfo(unit, isEnemy = false) {
            const infoDiv = document.getElementById('unit-info');
            let html = `
                <div style="font-size: 1.2em; margin-bottom: 10px;">
                    <strong>${unit.type} ${unit.name}</strong>
                </div>
                <div class="unit-stats">
                    <div>‚ù§Ô∏è HP: ${unit.hp}</div>
                    <div>‚öîÔ∏è –ê—Ç–∞–∫–∞: ${unit.attack}</div>
                    <div>üèÉ –ò–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞: ${unit.initiative}</div>
                    <div>üìè –î–∞–ª—å–Ω–æ—Å—Ç—å: ${unit.range || 1}</div>
                </div>`;

            if (!isEnemy && unit.activeAbility) {
                html += `
                    <div class="unit-ability">
                        <div class="ability-name">‚ú® ${unit.activeAbility.name}</div>
                        <div class="ability-description">${unit.activeAbility.description}</div>
                        <div class="cooldown-info">‚è±Ô∏è –ü–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞: ${unit.activeAbility.cooldown} —Ö–æ–¥–∞</div>
                    </div>`;
            }

            if (!isEnemy && unit.passiveAbility) {
                html += `
                    <div class="unit-ability">
                        <div class="ability-name">üîÆ ${unit.passiveAbility.name}</div>
                        <div class="ability-description">${unit.passiveAbility.description}</div>
                    </div>`;
            }

            if (!isEnemy) {
                html += `
                    <div class="action-buttons">
                        <button class="action-button ${currentAction === 'move' ? 'active' : ''}" 
                                onclick="setAction('move')">üèÉ –î–≤–∏–∂–µ–Ω–∏–µ</button>
                        <button class="action-button ${currentAction === 'attack' ? 'active' : ''}" 
                                onclick="setAction('attack')">‚öîÔ∏è –ê—Ç–∞–∫–∞</button>
                        <button class="action-button ${currentAction === 'special' ? 'active' : ''}" 
                                onclick="setAction('special')">‚ú® –°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å</button>
                        <button class="skip-turn-button" onclick="skipTurn()">‚è≠Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ö–æ–¥</button>
                    </div>`;
            }

            infoDiv.innerHTML = html;
        }

        function logAction(text) {
            const log = document.getElementById('action-log');
            const entry = document.createElement('div');
            entry.innerHTML = text;
            log.insertBefore(entry, log.firstChild);
        }

        function checkVictory() {
            if(units.player.length === 0) {
                alert('‚ò†Ô∏è –ü–æ—Ä–∞–∂–µ–Ω–∏–µ! –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                initGame();
            }
            if(units.enemy.length === 0) {
                if(currentLevel < 3) {
                    alert('üéâ –ü–æ–±–µ–¥–∞! –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å!');
                    currentLevel++;
                    initGame();
                } else {
                    alert('üèÜ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –ø—Ä–æ—à–ª–∏ –≤—Å–µ —É—Ä–æ–≤–Ω–∏!');
                    initGame();
                }
            }
        }

        function updateBattlefield() {
            const cells = document.getElementsByClassName('cell');
            for(let cell of cells) {
                cell.innerHTML = '';
                cell.classList.remove('selected', 'available-move', 'available-attack', 'available-special');
            }

            [...units.player, ...units.enemy].forEach(unit => {
                const cell = document.querySelector(`[data-x="${unit.x}"][data-y="${unit.y}"]`);
                if(cell) {
                    cell.innerHTML = unit.type;
                    if(unit === selectedUnit) {
                        cell.classList.add('selected');
                    }
                }
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –≤—Ä–∞–≥–æ–≤
            document.getElementById('enemies-left').textContent = units.enemy.length;

            // –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–µ–∫—É—â–∏–π —é–Ω–∏—Ç –∏–≥—Ä–æ–∫–∞, –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –µ–≥–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ö–æ–¥—ã
            const currentUnit = turnQueue[currentUnitIndex];
            if(currentUnit && units.player.includes(currentUnit)) {
                highlightAvailableCells(currentUnit);
            }
        }

        function setAction(action) {
            currentAction = action;
            const buttons = document.querySelectorAll('.action-button');
            buttons.forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.action-button[onclick="setAction('${action}')"]`).classList.add('active');
            
            if (selectedUnit) {
                highlightAvailableCells(selectedUnit);
            }
        }

        function useSpecialAbility(unit, targetX, targetY) {
            if (unit.cooldowns && unit.cooldowns.special > 0) {
                logAction(`‚ùå –°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å ${unit.type} ${unit.name} –µ—â–µ –ø–µ—Ä–µ–∑–∞—Ä—è–∂–∞–µ—Ç—Å—è (${unit.cooldowns.special} —Ö–æ–¥–æ–≤)`);
                return;
            }

            switch(unit.type) {
                case 'üßô': // –ú–∞–≥ - –û–≥–Ω–µ–Ω–Ω—ã–π —à–∞—Ä
                    const enemyMage = units.enemy.find(e => e.x === targetX && e.y === targetY);
                    if (enemyMage) {
                        attack(unit, enemyMage, unit.attack * 1.5);
                        // –£—Ä–æ–Ω –ø–æ —Å–æ—Å–µ–¥–Ω–∏–º –∫–ª–µ—Ç–∫–∞–º
                        units.enemy.forEach(e => {
                            if (Math.abs(e.x - targetX) <= 1 && Math.abs(e.y - targetY) <= 1 && e !== enemyMage) {
                                attack(unit, e, unit.attack * 0.5);
                            }
                        });
                        unit.cooldowns.special = unit.activeAbility.cooldown;
                    }
                    break;

                case 'ü¶Å': // –õ–µ–≤ - –†–µ–≤
                    const affectedEnemies = units.enemy.filter(e => 
                        Math.abs(e.x - targetX) <= unit.activeAbility.range && 
                        Math.abs(e.y - targetY) <= unit.activeAbility.range
                    );
                    affectedEnemies.forEach(enemy => {
                        enemy.initiative -= 2;
                        logAction(`ü¶Å ${unit.type} ${unit.name} –æ–≥–ª—É—à–∞–µ—Ç ${enemy.type} ${enemy.name}`);
                    });
                    unit.cooldowns.special = unit.activeAbility.cooldown;
                    break;

                case 'üèπ': // –õ—É—á–Ω–∏–∫ - –ó–∞–ª–ø
                    const targets = units.enemy
                        .filter(e => Math.abs(e.x - unit.x) <= unit.activeAbility.range)
                        .slice(0, 3);
                    targets.forEach(target => {
                        attack(unit, target, unit.attack * 0.7);
                    });
                    unit.cooldowns.special = unit.activeAbility.cooldown;
                    break;

                case 'üíâ': // –õ–µ–∫–∞—Ä—å - –ò—Å—Ü–µ–ª–µ–Ω–∏–µ
                    const ally = units.player.find(p => p.x === targetX && p.y === targetY);
                    if (ally) {
                        const healAmount = 30;
                        ally.hp += healAmount;
                        logAction(`üíö ${unit.type} ${unit.name} –∏—Å—Ü–µ–ª—è–µ—Ç ${ally.type} ${ally.name} (+${healAmount} HP)`);
                        unit.cooldowns.special = unit.activeAbility.cooldown;
                    }
                    break;

                case 'üêâ': // –î—Ä–∞–∫–æ–Ω—á–∏–∫ - –û–≥–Ω–µ–Ω–Ω–æ–µ –¥—ã—Ö–∞–Ω–∏–µ
                    const lineTargets = units.enemy.filter(e => {
                        const dx = e.x - unit.x;
                        const dy = e.y - unit.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        return distance <= unit.activeAbility.range;
                    });
                    lineTargets.forEach(target => {
                        attack(unit, target, unit.attack * 1.3);
                    });
                    unit.cooldowns.special = unit.activeAbility.cooldown;
                    break;
            }
        }

        function skipTurn() {
            if(selectedUnit) {
                logAction(`‚è≠Ô∏è ${selectedUnit.type} ${selectedUnit.name} –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç —Ö–æ–¥`);
                selectedUnit = null;
                endTurn();
            }
        }

        initGame();
    </script>
</body>
</html> 