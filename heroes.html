<!DOCTYPE html>
<html>
<head>
    <title>–≠–º–æ–¥–∑–∏-–±–∏—Ç–≤–∞</title>
    <style>
        #battlefield {
            border-collapse: collapse;
            margin: 20px;
        }
        
        .cell {
            width: 60px;
            height: 60px;
            border: 1px solid #ccc;
            text-align: center;
            font-size: 30px;
            cursor: pointer;
            position: relative;
        }
        
        .selected {
            background-color: #ffeb3b;
        }
        
        .info {
            margin: 20px;
            font-family: Arial;
        }
        
        .unit-info {
            position: fixed;
            right: 20px;
            top: 20px;
            background: white;
            padding: 10px;
            border: 1px solid #ccc;
        }

        @keyframes attack-animation {
            0% { transform: translate(0, 0); }
            50% { transform: translate(10px, -5px); }
            100% { transform: translate(0, 0); }
        }

        .attack-effect {
            animation: attack-animation 0.3s ease-in-out;
        }

        #action-log {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div class="info">–¢–µ–∫—É—â–∏–π —Ö–æ–¥: <span id="current-turn">-</span></div>
    <table id="battlefield"></table>
    <div class="unit-info" id="unit-info"></div>
    <div class="info" id="action-log"></div>

    <script>
        const units = {
            player: [
                {type: 'ü¶Å', name: '–õ–µ–≤', hp: 120, attack: 18, initiative: 8, x: 0, y: 1},
                {type: 'üõ°Ô∏è', name: '–†—ã—Ü–∞—Ä—å', hp: 150, attack: 15, initiative: 5, x: 0, y: 2},
                {type: 'üßô', name: '–ú–∞–≥', hp: 80, attack: 25, initiative: 7, x: 0, y: 3}
            ],
            enemy: [
                {type: 'üëπ', name: '–î–µ–º–æ–Ω', hp: 130, attack: 20, initiative: 6, x: 4, y: 1},
                {type: 'üßü', name: '–ó–æ–º–±–∏', hp: 90, attack: 12, initiative: 3, x: 4, y: 2},
                {type: 'üëª', name: '–ü—Ä–∏–∑—Ä–∞–∫', hp: 70, attack: 18, initiative: 9, x: 4, y: 3}
            ]
        };

        let selectedUnit = null;
        let turnQueue = [];
        let currentUnitIndex = 0;

        function initGame() {
            createBattlefield();
            startNewRound();
        }

        function createBattlefield() {
            const table = document.getElementById('battlefield');
            table.innerHTML = '';
            for(let y = 0; y < 5; y++) {
                const row = table.insertRow();
                for(let x = 0; x < 5; x++) {
                    const cell = row.insertCell();
                    cell.className = 'cell';
                    cell.dataset.x = x;
                    cell.dataset.y = y;
                    cell.addEventListener('click', handleCellClick);
                }
            }
            updateBattlefield();
        }

        function startNewRound() {
            turnQueue = [...units.player, ...units.enemy]
                .sort((a, b) => b.initiative - a.initiative);
            
            currentUnitIndex = 0;
            processNextTurn();
        }

        function processNextTurn() {
            if(currentUnitIndex >= turnQueue.length) {
                startNewRound();
                return;
            }

            const currentUnit = turnQueue[currentUnitIndex];
            const isPlayerUnit = units.player.includes(currentUnit);
            
            document.getElementById('current-turn').textContent = 
                `${currentUnit.type} ${currentUnit.name} (${isPlayerUnit ? '–ò–≥—Ä–æ–∫' : '–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫'})`;

            if(!isPlayerUnit) {
                setTimeout(() => enemyTurn(currentUnit), 500);
            }
        }

        function updateBattlefield() {
            const cells = document.getElementsByClassName('cell');
            for(let cell of cells) {
                cell.innerHTML = '';
                cell.classList.remove('selected');
            }

            [...units.player, ...units.enemy].forEach(unit => {
                const cell = document.querySelector(`[data-x="${unit.x}"][data-y="${unit.y}"]`);
                if(cell) {
                    cell.innerHTML = unit.type;
                    if(unit === selectedUnit) cell.classList.add('selected');
                }
            });
        }

        function handleCellClick(e) {
            const currentUnit = turnQueue[currentUnitIndex];
            if(!units.player.includes(currentUnit)) return;

            const x = parseInt(e.target.dataset.x);
            const y = parseInt(e.target.dataset.y);
            
            const unit = units.player.find(u => u.x === x && u.y === y);
            if(unit && unit === currentUnit) {
                selectedUnit = unit;
                updateBattlefield();
                showUnitInfo(unit);
                return;
            }

            if(selectedUnit === currentUnit) {
                if(isEmptyCell(x, y) && isAdjacent(selectedUnit, {x, y})) {
                    moveUnit(selectedUnit, x, y);
                    selectedUnit = null;
                    endTurn();
                }
                else {
                    const enemy = units.enemy.find(u => u.x === x && u.y === y);
                    if(enemy && isAdjacent(selectedUnit, enemy)) {
                        attack(selectedUnit, enemy);
                        endTurn();
                    }
                }
            }
        }

        function endTurn() {
            currentUnitIndex++;
            selectedUnit = null;
            document.getElementById('unit-info').innerHTML = '';
            processNextTurn();
        }

        function isEmptyCell(x, y) {
            return ![...units.player, ...units.enemy].some(u => u.x === x && u.y === y);
        }

        function isAdjacent(a, b) {
            return Math.abs(a.x - b.x) <= 1 && Math.abs(a.y - b.y) <= 1;
        }

        function moveUnit(unit, newX, newY) {
            unit.x = newX;
            unit.y = newY;
            logAction(`üèÉ ${unit.type} ${unit.name} –ø–µ—Ä–µ–º–µ—â–∞–µ—Ç—Å—è –Ω–∞ (${newX}, ${newY})`);
            updateBattlefield();
        }

        function attack(attacker, defender) {
            const attackerCell = document.querySelector(`[data-x="${attacker.x}"][data-y="${attacker.y}"]`);
            attackerCell.classList.add('attack-effect');
            
            setTimeout(() => {
                defender.hp -= attacker.attack;
                logAction(`‚öîÔ∏è ${attacker.type} ${attacker.name} –∞—Ç–∞–∫—É–µ—Ç ${defender.type} ${defender.name} (${defender.hp + attacker.attack} ‚Üí ${defender.hp})`);
                
                if(defender.hp <= 0) {
                    const faction = units.player.includes(defender) ? 'player' : 'enemy';
                    units[faction] = units[faction].filter(u => u !== defender);
                    logAction(`üíÄ ${defender.type} ${defender.name} —É–Ω–∏—á—Ç–æ–∂–µ–Ω!`);
                    checkVictory();
                }
                attackerCell.classList.remove('attack-effect');
                updateBattlefield();
            }, 300);
        }

        function enemyTurn(currentUnit) {
            const targets = [...units.player];
            if(targets.length === 0) return;

            let nearestTarget = targets.reduce((prev, curr) => 
                distance(currentUnit, curr) < distance(currentUnit, prev) ? curr : prev
            , targets[0]);

            // –õ–æ–≥–∏–∫–∞ –∞—Ç–∞–∫–∏
            if(isAdjacent(currentUnit, nearestTarget)) {
                attack(currentUnit, nearestTarget);
                endTurn();
                return;
            }

            // –£–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–≤–∏–∂–µ–Ω–∏—è
            const dx = nearestTarget.x - currentUnit.x;
            const dy = nearestTarget.y - currentUnit.y;
            
            let moveX = currentUnit.x;
            let moveY = currentUnit.y;
            
            // –ü—Ä–æ–±—É–µ–º –¥–≤–∏–≥–∞—Ç—å—Å—è –ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏, –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ
            if(isValidCell({x: currentUnit.x + Math.sign(dx), y: currentUnit.y + Math.sign(dy)})) {
                moveX += Math.sign(dx);
                moveY += Math.sign(dy);
            } 
            // –ò–Ω–∞—á–µ –¥–≤–∏–≥–∞–µ–º—Å—è –ø–æ –ø—Ä—è–º–æ–π
            else if(Math.abs(dx) > Math.abs(dy)) {
                moveX += Math.sign(dx);
            } else {
                moveY += Math.sign(dy);
            }

            // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –¥–≤–∏–≥–∞—Ç—å—Å—è, –ø—Ä–æ–±—É–µ–º –æ–±–æ–π—Ç–∏ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
            if(!isValidCell({x: moveX, y: moveY})) {
                const possibleMoves = [
                    {x: currentUnit.x + 1, y: currentUnit.y},
                    {x: currentUnit.x - 1, y: currentUnit.y},
                    {x: currentUnit.x, y: currentUnit.y + 1},
                    {x: currentUnit.x, y: currentUnit.y - 1}
                ];
                
                for(let move of possibleMoves) {
                    if(isValidCell(move)) {
                        moveX = move.x;
                        moveY = move.y;
                        break;
                    }
                }
            }
            
            if(moveX !== currentUnit.x || moveY !== currentUnit.y) {
                moveUnit(currentUnit, moveX, moveY);
            }
            
            endTurn();
        }

        function distance(unit1, unit2) {
            return Math.abs(unit1.x - unit2.x) + Math.abs(unit1.y - unit2.y);
        }

        function isValidCell(pos) {
            return pos.x >= 0 && pos.x < 5 && pos.y >= 0 && pos.y < 5 && isEmptyCell(pos.x, pos.y);
        }

        function showUnitInfo(unit) {
            const infoDiv = document.getElementById('unit-info');
            infoDiv.innerHTML = `
                <strong>${unit.type} ${unit.name}</strong><br>
                ‚ù§Ô∏è HP: ${unit.hp}<br>
                ‚öîÔ∏è –ê—Ç–∞–∫–∞: ${unit.attack}<br>
                üèÉ –ò–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞: ${unit.initiative}
            `;
        }

        function logAction(text) {
            const log = document.getElementById('action-log');
            const entry = document.createElement('div');
            entry.innerHTML = text;
            log.insertBefore(entry, log.firstChild);
        }

        function checkVictory() {
            if(units.player.length === 0) alert('‚ò†Ô∏è –ü–æ–±–µ–¥–∞ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞!');
            if(units.enemy.length === 0) alert('üéâ –ü–æ–±–µ–¥–∞ –∏–≥—Ä–æ–∫–∞!');
        }

        initGame();
    </script>
</body>
</html>